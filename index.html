<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PDF Viewer</title>

    <meta name="viewport"
          content="width=device-width, height=device-height,
                   initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
        }

        #viewer {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        canvas, .linkLayer {
            position: absolute;
            top: 0;
            left: 0;
        }

        .linkLayer a {
            pointer-events: auto;
            position: absolute;
            display: block;
            background: rgba(255, 255, 255, 0.12);
            border-bottom: 2px solid rgba(255, 255, 255, 0.8);
            border-radius: 2px;
            text-decoration: none;
        }
    </style>
</head>

<body>
    <div id="viewer">
        <canvas id="pdf"></canvas>
        <div id="linkLayer" class="linkLayer"></div>
    </div>

    <script type="module">
        import * as pdfjsLib from './pdfjs/pdf.mjs';

        pdfjsLib.GlobalWorkerOptions.workerSrc = './pdfjs/pdf.worker.mjs';

        const PDF_URL = './document.pdf';
        const canvas = document.getElementById('pdf');
        const ctx = canvas.getContext('2d');
        const linkLayer = document.getElementById('linkLayer');

        const MAX_CANVAS_SIZE = 8192;

        function getSafeDPR() {
            const dpr = window.devicePixelRatio || 1;
            const isMobile = /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent);
            return isMobile ? Math.min(dpr, 2) : dpr;
        }

        async function render() {
            const pdf = await pdfjsLib.getDocument(PDF_URL).promise;
            const page = await pdf.getPage(1);

            const viewport = page.getViewport({ scale: 1 });

            const scale = Math.min(
                window.innerWidth / viewport.width,
                window.innerHeight / viewport.height
            );

            const dpr = getSafeDPR();

            let pixelViewport = page.getViewport({ scale: scale * dpr });

            // ---- GPU SAFETY NET (mobile) ----
            if (
                pixelViewport.width > MAX_CANVAS_SIZE ||
                pixelViewport.height > MAX_CANVAS_SIZE
            ) {
                const downscale = Math.min(
                    MAX_CANVAS_SIZE / pixelViewport.width,
                    MAX_CANVAS_SIZE / pixelViewport.height
                );

                pixelViewport = page.getViewport({
                    scale: scale * dpr * downscale
                });
            }

            // Canvas pixel size
            canvas.width = pixelViewport.width;
            canvas.height = pixelViewport.height;

            // CSS display size
            const displayWidth = viewport.width * scale;
            const displayHeight = viewport.height * scale;

            const offsetX = (window.innerWidth - displayWidth) / 2;
            const offsetY = (window.innerHeight - displayHeight) / 2;

            canvas.style.width = `${displayWidth}px`;
            canvas.style.height = `${displayHeight}px`;
            canvas.style.left = `${offsetX}px`;
            canvas.style.top = `${offsetY}px`;

            linkLayer.style.width = `${displayWidth}px`;
            linkLayer.style.height = `${displayHeight}px`;
            linkLayer.style.left = `${offsetX}px`;
            linkLayer.style.top = `${offsetY}px`;

            ctx.setTransform(1, 0, 0, 1, 0, 0);

            await page.render({
                canvasContext: ctx,
                viewport: pixelViewport,
                background: 'rgba(0,0,0,0)'
            }).promise;

            // ---- LINK LAYER ----
            linkLayer.innerHTML = '';
            const annotations = await page.getAnnotations();

            annotations.forEach((ann) => {
                if (ann.subtype === 'Link' && ann.url) {
                    const rect = pdfjsLib.Util.normalizeRect(ann.rect);
                    const view = pixelViewport.convertToViewportRectangle(rect);

                    const left = Math.min(view[0], view[2]);
                    const top = Math.min(view[1], view[3]);
                    const width = Math.abs(view[2] - view[0]);
                    const height = Math.abs(view[3] - view[1]);

                    const a = document.createElement('a');
                    a.href = ann.url;
                    a.target = '_blank';

                    a.style.left = `${left / dpr}px`;
                    a.style.top = `${top / dpr}px`;
                    a.style.width = `${width / dpr}px`;
                    a.style.height = `${height / dpr}px`;

                    linkLayer.appendChild(a);
                }
            });
        }

        render();

        // ---- DEBOUNCED RESIZE (mobile-safe) ----
        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(render, 150);
        });
    </script>
</body>
</html>
